import{bz as k,ar as L,as as S,bs as Y,r as D,bg as K,s as H,c as J,aS as T,t as w,f8 as X,b0 as Z,f9 as ee,bo as te,b6 as se,bT as re,c7 as ie,c8 as ae,bb as ne,c9 as oe,b9 as le,ba as he,bH as de,eR as ce,ai as ue,dK as me,ed as pe,ee as fe,fa as ye,aV as _e,w as ve,f6 as we,e as x,y as A,n as ge,bI as Re,fb as Me}from"./index.3224a022.js";import{r as be}from"./utils.918c3f1c.js";import{E as W,a as Te}from"./VertexArrayObject.d81d1493.js";import{P as xe,G as Ee,L as Ce,D as $e,F as z}from"./enums.2d9e6f64.js";import{n as G,E as Ve}from"./Texture.8b5010fc.js";import{r as qe}from"./vec3f32.1121a836.js";import{o as Se,c as Ae}from"./WGLContainer.85a9794d.js";import{I as De}from"./Utils.162909bd.js";import{y as Ie,u as Pe}from"./LayerView.5282a6c2.js";import"./MaterialKey.93985d90.js";import"./enums.0295eb81.js";import"./pixelUtils.a7f9a619.js";import"./VertexElementDescriptor.1fdca6da.js";import"./ProgramTemplate.93880f08.js";import"./StyleDefinition.d56936e4.js";import"./config.82550349.js";import"./GeometryUtils.51c4032a.js";import"./earcut.afc1d357.js";const _=ee();class Oe extends be{constructor(s){super(),this.elementView=s,this.isWrapAround=!1,this.perspectiveTransform=k(),this._vertices=new Float32Array(20),this._handles=[],this._handles.push(L(()=>this.elementView.element.opacity,t=>this.opacity=t,S),L(()=>[this.elementView.coords],()=>{this.requestRender()},S),Y(()=>this.elementView.element.loaded,()=>{const t=this.elementView.element;this.ready(),t.type==="video"&&D(t.content)&&this._handles.push(K(t.content,"play",()=>this.requestRender()))},S)),s.element.load().catch(t=>{H.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new J("element-load-error","Element cannot be displayed",{element:s,error:t}))})}destroy(){var s;this._handles.forEach(t=>t.remove()),(s=this.texture)==null||s.dispose(),this.texture=null}get dvsMat3(){return this.parent.dvsMat3}beforeRender(s){const{context:t}=s,e=this.elementView.element.content;if(D(e)){const a=e instanceof HTMLImageElement,i=e instanceof HTMLVideoElement,n=a?e.naturalWidth:i?e.videoWidth:e.width,h=a?e.naturalHeight:i?e.videoHeight:e.height;this._updatePerspectiveTransform(n,h),this.texture?i&&!e.paused&&(this.texture.setData(e),this.requestRender(),(G(t.gl)||T(n)&&T(h))&&this.texture.generateMipmap()):(this.texture=new Ve(t,{pixelFormat:xe.RGBA,dataType:Ee.UNSIGNED_BYTE,samplingMode:Ce.LINEAR,wrapMode:$e.CLAMP_TO_EDGE,width:n,height:h,preMultiplyAlpha:!0},e),(G(t.gl)||T(n)&&T(h))&&this.texture.generateMipmap(),i&&!e.paused&&this.requestRender())}super.beforeRender(s)}_createTransforms(){return null}updateDrawCoords(s,t){const e=this.elementView.coords;if(w(e))return;const[a,i,n,h]=e.rings[0],m=this._vertices,{x:o,y:l}=s,c=t!==0;c?m.set([i[0]-o,i[1]-l,a[0]-o,a[1]-l,n[0]-o,n[1]-l,h[0]-o,h[1]-l,h[0]-o,h[1]-l,i[0]+t-o,i[1]-l,i[0]+t-o,i[1]-l,a[0]+t-o,a[1]-l,n[0]+t-o,n[1]-l,h[0]+t-o,h[1]-l]):m.set([i[0]-o,i[1]-l,a[0]-o,a[1]-l,n[0]-o,n[1]-l,h[0]-o,h[1]-l]),this.isWrapAround=c}getVAO(s,t,e){if(w(this.elementView.coords))return null;const a=this._vertices;if(this._vao)this._geometryVbo.setData(a);else{this._geometryVbo=W.createVertex(s,z.DYNAMIC_DRAW,a);const i=W.createVertex(s,z.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new Te(s,e,t,{geometry:this._geometryVbo,tex:i})}return this._vao}_updatePerspectiveTransform(s,t){const e=this._vertices;X(_,[0,0,s,0,0,t,s,t],[e[0],e[1],e[4],e[5],e[2],e[3],e[6],e[7]]),Z(this.perspectiveTransform,_[6]/_[8]*s,_[7]/_[8]*t)}}class Ue extends Se{constructor(){super(...arguments),this._localOrigin=te(0,0),this._viewStateId=-1,this._dvsMat3=se(),this.requiresDedicatedFBO=!1}get dvsMat3(){return this._dvsMat3}beforeRender(s){this._updateMatrices(s),this._updateOverlays(s,this.children);for(const t of this.children)t.beforeRender(s)}prepareRenderPasses(s){const t=s.registerRenderPass({name:"overlay",brushes:[Ae.overlay],target:()=>this.children,drawPhase:De.MAP});return[...super.prepareRenderPasses(s),t]}_updateMatrices(s){const{state:t}=s,{id:e,size:a,pixelRatio:i,resolution:n,rotation:h,viewpoint:m,displayMat3:o}=t;if(this._viewStateId===e)return;const l=Math.PI/180*h,c=i*a[0],f=i*a[1],{x:g,y:E}=m.targetGeometry,C=re(g,t.spatialReference);this._localOrigin.x=C,this._localOrigin.y=E;const R=n*c,y=n*f,d=ie(this._dvsMat3);ae(d,d,o),ne(d,d,oe(c/2,f/2)),le(d,d,qe(c/R,-f/y,1)),he(d,d,-l),this._viewStateId=e}_updateOverlays(s,t){const{state:e}=s,{rotation:a,spatialReference:i,worldScreenWidth:n,size:h,viewpoint:m}=e,o=this._localOrigin;let l=0;if(i.isWrappable){const c=h[0],f=h[1],g=180/Math.PI*a,E=Math.abs(Math.cos(g)),C=Math.abs(Math.sin(g)),R=Math.round(c*E+f*C),[y,d]=de(i).valid,u=ce(i),{x:I,y:Q}=m.targetGeometry,B=[I,Q],$=[0,0];e.toScreen($,B);const M=[0,0];let V;V=R>n?.5*n:.5*R;const P=Math.floor((I+.5*u)/u),F=y+P*u,N=d+P*u,q=[$[0]+V,0];e.toMap(M,q),M[0]>N&&(l=u),q[0]=$[0]-V,e.toMap(M,q),M[0]<F&&(l=-u);for(const b of t){const O=b.elementView.bounds;if(w(O))continue;const[U,,j]=O;U<y&&j>y?b.updateDrawCoords(o,u):j>d&&U<d?b.updateDrawCoords(o,-u):b.updateDrawCoords(o,l)}}else for(const c of t)c.updateDrawCoords(o,l)}}let p=class extends Ie(Pe){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this.layer=null,this.elements=new ue}attach(){this.handles.add(me(()=>this.layer.source,"refresh",()=>{for(const r of this._tileStrategy.tiles)this._updateTile(r);this.requestUpdate()})),this._overlayContainer=new Ue,this.container.addChild(this._overlayContainer),this._fetchQueue=new pe({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(r,s)=>this._queryElements(r,s)}),this._tileStrategy=new fe({cachePolicy:"purge",resampling:!0,acquireTile:r=>this._acquireTile(r),releaseTile:r=>this._releaseTile(r),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.handles.removeAll(),this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear()}supportsSpatialReference(r){return!0}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(r){this._tileStrategy.update(r)}async hitTest(r,s){const t=[],e=r.normalize(),a=[e.x,e.y];for(const{projectedElement:{normalizedCoords:i,element:n}}of this._elementReferences.values())D(i)&&ye(i.rings,a)&&t.push({type:"media",element:n,layer:this.layer,mapPoint:r});return t.reverse()}canResume(){return this.layer.source!=null&&super.canResume()}async doRefresh(){}_acquireTile(r){const s=new je(r.clone());return this._updateTile(s),s}_updateTile(r){this.updatingHandles.addPromise(this._fetchQueue.push(r.key).then(s=>{const[t,e]=r.setElements(s);this._acquireElements(r,t),this._releaseElements(r,e),this.requestUpdate()},s=>{_e(s)||H.getLogger(this.declaredClass).error(s)}))}_releaseTile(r){this._fetchQueue.abort(r.key.id),r.elements&&this._releaseElements(r,r.elements),this.requestUpdate()}async _queryElements(r,s){const t=this.layer.source;if(w(t))return[];this.view.featuresTilingScheme.getTileBounds(v,r,!0);const e=new ve({xmin:v[0],ymin:v[1],xmax:v[2],ymax:v[3],spatialReference:this.view.spatialReference});return t.queryElements(e,s)}_acquireElements(r,s){const t=this.layer.source,e=this.view.spatialReference;if(!w(t))for(const a of s)we(this._elementReferences,a.uid,()=>{const i=new Me({element:a,spatialReference:e}),n=new Oe(i);return this._overlayContainer.addChild(n),this.elements.add(a),{tiles:new Set,projectedElement:i,overlay:n}}).tiles.add(r)}_releaseElements(r,s){for(const t of s){const e=this._elementReferences.get(t.uid);e.tiles.delete(r),e.tiles.size||(this._overlayContainer.removeChild(e.overlay),e.overlay.destroy(),e.projectedElement.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t))}}};x([A()],p.prototype,"_fetchQueue",void 0),x([A()],p.prototype,"layer",void 0),x([A({readOnly:!0})],p.prototype,"elements",void 0),p=x([ge("esri.views.2d.layers.MediaLayerView2D")],p);const v=Re();class je{constructor(s){this.key=s,this.elements=null,this.isReady=!1,this.visible=!0}setElements(s){const t=[],e=new Set(this.elements);this.elements=s;for(const a of s)e.has(a)?e.delete(a):t.push(a);return this.isReady=!0,[t,Array.from(e)]}}const rt=p;export{rt as default};
