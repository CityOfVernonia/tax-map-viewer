import{aj as C,ak as N,al as S,ao as L,ah as h,an as P,c as p,e as o,y as s,n as u,am as E,at as $,az as T,k as H,dQ as M}from"./index.3224a022.js";import{l as x,j as A,g as O}from"./geolocationUtils.12f08bfe.js";import"./project.4c40b375.js";const U=2500;let n=class extends C(N.EventedMixin(S)){constructor(){super(...arguments),this._geolocationUsable=!0,this._iconPath=L("esri/images/support/sdk_gps_location.png"),this.geolocationOptions=null,this.goToLocationEnabled=!0,this.graphic=new h({symbol:new P({url:this._iconPath,width:21,height:21})}),this.scale=null,this.useHeadingEnabled=!0,this.view=null}initialize(){x()||(this._geolocationUsable=!1)}destroy(){this._clear(),this.view=null}_clear(){this.view&&this.view.graphics.remove(this.graphic)}_getScaleWithinConstraints(t,e){if(!e)return t;if(e.type==="2d"){const{effectiveMaxScale:a,effectiveMinScale:i}=e.constraints;return Math.min(i,Math.max(a,t))}return t}_getScale(t){const{scale:e}=this,a=typeof e=="number"?e:U;return this._getScaleWithinConstraints(a,t)}_getHeading(t,e){const a=e&&e.spatialReference,i=a&&(a.isWebMercator||a.isGeographic),l=t.coords&&t.coords.heading;if(!(!i||typeof l!="number"||isNaN(l)||l<0||l>360))return l}_addHeading(t){const{heading:e,target:a,view:i}=t;i&&typeof e=="number"&&!isNaN(e)&&(i.type!=="3d"?i.type==="2d"&&(a.rotation=360-e):a.heading=e)}_animatePoint(t,e,a,i){const{view:l}=this;if(!this.goToLocationEnabled||!l)return Promise.resolve(e);const d=this.useHeadingEnabled?this._getHeading(e,l):void 0,c={target:t,scale:a};return this._addHeading({heading:d,target:c,view:l}),this.callGoTo({target:c,options:i}).then(()=>e)}async _setPosition(t,e){try{const a=await A({position:t,view:this.view},e),{graphic:i}=this,{timestamp:l}=t,{coords:d}=t,{accuracy:c,altitude:g,altitudeAccuracy:m,heading:y,latitude:f,longitude:_,speed:w}=d,b={timestamp:l,accuracy:c,altitude:g,altitudeAccuracy:m,heading:y,latitude:f,longitude:_,speed:w};i&&(i.geometry=a,i.attributes=b);const v=this._getScale(this.view);return this._animatePoint(a,t,v,e)}catch(a){throw new p("positioning:invalid-point","Cannot position invalid point",{error:a})}}};o([s()],n.prototype,"_geolocationUsable",void 0),o([s()],n.prototype,"geolocationOptions",void 0),o([s()],n.prototype,"goToLocationEnabled",void 0),o([s({type:h,nonNullable:!0})],n.prototype,"graphic",void 0),o([s()],n.prototype,"scale",void 0),o([s()],n.prototype,"useHeadingEnabled",void 0),o([s()],n.prototype,"view",void 0),n=o([u("esri.widgets.support.GeolocationPositioning")],n);const k=n;async function z(){const t=await T("esri/widgets/Locate/t9n/Locate");return new H({title:t.currentLocation,fieldInfos:[{fieldName:"timestamp",label:t.timestamp,format:{dateFormat:"short-date-short-time"}},{fieldName:"latitude",label:t.latitude,format:{places:4,digitSeparator:!0}},{fieldName:"longitude",label:t.longitude,format:{places:4,digitSeparator:!0}},{fieldName:"accuracy",label:t.accuracy,format:{places:0,digitSeparator:!0}},{fieldName:"altitude",label:t.altitude,format:{places:0,digitSeparator:!0}},{fieldName:"altitudeAccuracy",label:t.altitudeAccuracy,format:{places:0,digitSeparator:!0}},{fieldName:"heading",label:t.heading,format:{places:0,digitSeparator:!0}},{fieldName:"speed",label:t.speed,format:{places:0,digitSeparator:!0}}],actions:[M.clone()],content:[{type:"fields"}]})}let r=class extends k{constructor(t){super(t),this._locateController=null,this._handles=new E,this.popupEnabled=!0,this.locate=this.locate.bind(this)}initialize(){this._handles.add([$(()=>{var i;const{graphic:t,view:e}=this;((i=e==null?void 0:e.graphics)==null?void 0:i.includes(t))&&this._updatePopupTemplate(t)})])}destroy(){this.cancelLocate(),this._handles.destroy(),this._handles=null}get state(){return this._geolocationUsable?this.get("view.ready")?this._locateController?"locating":"ready":"disabled":"feature-unsupported"}async locate(){if(this.cancelLocate(),this.state==="disabled")throw new p("locate:disabled-state","Cannot locate when disabled.");if(this.state==="feature-unsupported")throw new p("locate:feature-unsupported-state","Cannot locate in unsecure domain.");const t=new AbortController;this._locateController=t;try{let e=await O(this.geolocationOptions);return e=await this._setPosition(e,{signal:t.signal}),this._locateController!==t?null:(this.graphic&&(this.graphic=this.graphic.clone(),await this._updatePopupTemplate(this.graphic),this.view.graphics.push(this.graphic)),this.emit("locate",{position:e}),this._locateController=null,e)}catch(e){throw this._locateController=null,this.emit("locate-error",{error:e}),e}}cancelLocate(){this._clear(),this._locateController&&this._locateController.abort(),this._locateController=null}async _updatePopupTemplate(t){if(!this.popupEnabled)return;const e=await z(),a=t!==this.graphic;this.destroyed||a||(t.popupTemplate=e)}};o([s()],r.prototype,"_locateController",void 0),o([s()],r.prototype,"popupEnabled",void 0),o([s({readOnly:!0})],r.prototype,"state",null),o([s()],r.prototype,"locate",null),o([s()],r.prototype,"cancelLocate",null),r=o([u("esri.widgets.Locate.LocateViewModel")],r);const F=r;export{F as default};
